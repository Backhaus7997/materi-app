generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  name         String
  email        String    @unique
  passwordHash String
  user_role    String    // 'Vendor' | 'Supplier'

  // relación opcional con Supplier (para proveedores)
  supplier     Supplier? @relation(fields: [supplierId], references: [id])
  supplierId   String?

  // relación para vendedores
  carts        Cart[]
  cartItems    CartItem[]

  // ✅ NUEVO: relación con quotes
  quotes       Quote[]

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
}

model Supplier {
  id             String    @id @default(cuid())
  name           String

  company_name   String?
  contact_person String?
  email          String?
  phone          String?
  address        String?
  notes          String?
  payment_terms  String?
  active         Boolean   @default(true)

  users          User[]
  products       Product[]
  quoteLineItems QuoteLineItem[]
  cartItems      CartItem[]

  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt
}

model Product {
  id              String    @id @default(cuid())

  //  supplier_id
  supplier        Supplier  @relation(fields: [supplierId], references: [id])
  supplierId      String

  //  supplier_name
  supplier_name   String?

  //  name (required)
  name            String

  //  internal_code
  internal_code   String?

  //  description
  description     String?

  //  image_url
  image_url       String?

  //  category
  category        String?

  //  unit_of_measure (default "unit")
  unit_of_measure String    @default("unit")

  //  base_price (required)
  base_price      Float

  //  currency (default "USD")
  currency        String    @default("USD")

  //  active (default true)
  active          Boolean   @default(true)

  quoteLineItems  QuoteLineItem[]
  cartItems       CartItem[]

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Quote {
  id                    String   @id @default(cuid())

  // ✅ NUEVO: vendor_id (required)
  vendor                User     @relation(fields: [vendorId], references: [id])
  vendorId              String

  //  quote_number
  quote_number          String? @unique

  //  customer_name (required)
  customer_name         String

  //  customer_company
  customer_company      String?

  //  customer_email
  customer_email        String?

  //  customer_phone
  customer_phone        String?

  //  status (default "Draft")
  status                String   @default("Draft")

  //  global_margin_percent (default 20)
  global_margin_percent Float    @default(20)

  //  total_cost (default 0)
  total_cost            Float    @default(0)

  //  total_sale_price (default 0)
  total_sale_price      Float    @default(0)

  //  total_profit_amount (default 0)
  total_profit_amount   Float    @default(0)

  //  notes
  notes                 String?

  // relación con líneas
  lineItems             QuoteLineItem[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model QuoteNumberSeq{
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
}

model QuoteLineItem {
  id        String   @id @default(cuid())

  //  quote_id (required)
  quote     Quote    @relation(fields: [quoteId], references: [id])
  quoteId   String

  //  supplier_id (opcional) + snapshot
  supplier        Supplier? @relation(fields: [supplierId], references: [id])
  supplierId      String?
  supplier_name   String?   // snapshot

  //  product_id (required)
  product   Product @relation(fields: [productId], references: [id])
  productId String
  product_name                 String? // snapshot
  product_description_snapshot String?

  //  unit_of_measure
  unit_of_measure String?

  //  quantity (required, default 1)
  quantity        Float   @default(1)

  //  unit_cost_price (required)
  unit_cost_price Float

  //  line_cost_total
  line_cost_total Float?  @default(0)

  //  margin_percent
  margin_percent  Float?

  //  unit_sale_price
  unit_sale_price Float?

  //  line_sale_total
  line_sale_total Float?  @default(0)

  //  line_profit_amount
  line_profit_amount Float? @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model Cart {
  id                    String   @id @default(cuid())

  //  vendor_id (required)
  vendor                User     @relation(fields: [vendorId], references: [id])
  vendorId              String

  //  global_margin_percent (default 20)
  global_margin_percent Float    @default(20)

  // relación con items
  items                 CartItem[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model CartItem {
  id        String   @id @default(cuid())

  //  cart_id (required)
  cart      Cart     @relation(fields: [cartId], references: [id])
  cartId    String

  //  vendor_id (snapshot opcional)
  vendor    User?    @relation(fields: [vendorId], references: [id])
  vendorId  String?

  //  supplier_id + snapshot
  supplier      Supplier? @relation(fields: [supplierId], references: [id])
  supplierId    String?
  supplier_name String?

  //  product_id (required) + snapshots
  product            Product @relation(fields: [productId], references: [id])
  productId          String
  product_name       String?
  product_description String?
  product_image_url  String?

  //  unit_of_measure
  unit_of_measure String?

  //  quantity (required, default 1)
  quantity        Float   @default(1)

  //  unit_cost_price (required)
  unit_cost_price Float

  //  margin_percent
  margin_percent  Float?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}
